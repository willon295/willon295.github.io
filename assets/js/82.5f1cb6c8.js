(window.webpackJsonp=window.webpackJsonp||[]).push([[82],{411:function(t,a,e){"use strict";e.r(a);var s=e(13),r=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"oauth2-使用场景-简单理解"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#oauth2-使用场景-简单理解"}},[t._v("#")]),t._v(" [OAuth2]使用场景_简单理解")]),t._v(" "),e("p",[t._v("用微信注册钉钉账号：")]),t._v(" "),e("ol",[e("li",[t._v("用微信账号注册钉钉")]),t._v(" "),e("li",[t._v("钉钉会唤起微信账号授权页面")]),t._v(" "),e("li",[t._v("用户确定授权")]),t._v(" "),e("li",[t._v("返回钉钉注册页面")]),t._v(" "),e("li",[t._v("钉钉读取用户微信基本信息")])]),t._v(" "),e("h2",{attrs:{id:"大前提"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#大前提"}},[t._v("#")]),t._v(" 大前提")]),t._v(" "),e("p",[t._v("这个场景的发生前提是：")]),t._v(" "),e("ol",[e("li",[t._v("微信有开放的第三方授权服务器，授权接口，资源服务器")]),t._v(" "),e("li",[t._v("钉钉 "),e("code",[t._v("作为客户端")]),t._v(" 在 "),e("code",[t._v("微信授权服务器")]),t._v(" 注册 , 且微信授权服务器给钉钉发放了唯一身份id （client_id）")])]),t._v(" "),e("h2",{attrs:{id:"角色划分"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#角色划分"}},[t._v("#")]),t._v(" 角色划分")]),t._v(" "),e("p",[t._v("那么我们对以上场景进行  "),e("strong",[t._v("角色划分")])]),t._v(" "),e("ul",[e("li",[t._v("用户 （User、Resource Owner）： 微信账号的拥有者（如：张三）")]),t._v(" "),e("li",[t._v("资源服务器 （Resource Server）： 微信存放用户信息的服务器")]),t._v(" "),e("li",[t._v("客户端 （Client）： 钉钉")]),t._v(" "),e("li",[t._v("授权服务器 （Authorization Server）： 微信控制客户端访问授权的服务器，负责授权码、token管理")])]),t._v(" "),e("p",[t._v("那么使用 "),e("code",[t._v("OAuth2")]),t._v(" ， 上面的交互场景工作流程如下：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("     +--------+                               +---------------+\n     |        |----A--是否授权 --------------\x3e|   用户确认    |\n     |        |                               |   微信授权    |\n     |        |<---B---授权码code-------------|               |\n     |        |                               +---------------+\n     |        |\n     |        |                               +---------------+\n     |        |-----C----授权码code----------\x3e|    微信授权   |\n     | 钉钉   |                               |     服务器    |\n     |        |<----D---发放Token-------------|               |\n     |        |                               +---------------+\n     |        |\n     |        |                               +---------------+\n     |        |----E------Token--------------\x3e|    微信资源   |\n     |        |                               |     服务器    |\n     |        |<---F------用户信息------------|               |\n     +--------+                               +---------------+\n")])])]),e("h2",{attrs:{id:"流程分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#流程分析"}},[t._v("#")]),t._v(" 流程分析")]),t._v(" "),e("p",[t._v("对以上流程每步进行分析")]),t._v(" "),e("p",[e("strong",[t._v("A流程")]),t._v(" ：  用户点击钉钉上的 "),e("code",[t._v("用微信注册")]),t._v(" ， 钉钉唤起微信， 发出授权请求携带以下信息")]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("client_id")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("dingdingxxxxxxx           #表明请求来自钉钉")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("response_type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("authorization_code    #表明返回类型是授权码")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("scope")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("user                          #表明需要的授权范围为user")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("redirect_uri")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("https://dingtalk.com/register/callback  #表明用户确认后回调的URL")]),t._v("\n")])])]),e("p",[e("strong",[t._v("B流程")]),t._v(" : 用户在微信上确定授权后， 微信携带 "),e("code",[t._v("授权码code")]),t._v("  向  "),e("code",[t._v("redirect_uri")]),t._v(" 发起 请求， 其他参数封不动的返回")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("https://dingtalk.com/register/callback?code=AAA123456&scope=user\n")])])]),e("p",[t._v("此时微信会唤起钉钉， 并且钉钉已获取到授权code， A、B流程结束")]),t._v(" "),e("p",[e("strong",[t._v("C流程")]),t._v(" ： 钉钉携带授权code再次向微信 "),e("code",[t._v("授权服务器")]),t._v(" 发起请求， 发起的请求数据大致：")]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("client_id")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("dingdingxxxxxxx           #表明请求来自钉钉")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("client_secret")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("dingdingXXXXX         #客户端加密信息 【可选】")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("grant_type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("authorization_code       #表明凭证类型是授权码")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("code")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("AAA123456\t\t\t\t\t\t\t #授权code")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("scope")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("user                          #表明需要的授权范围为user")]),t._v("\n")])])]),e("p",[e("strong",[t._v("D流程")]),t._v(" ： 微信授权服务器返回授权信息，包括")]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("access_token")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("er2rsersdf4534sds     #授权token")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("refresh_token")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("9834892sfsdfsf324    #刷新token ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("expire_in")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("864000\t\t\t\t\t\t#失效时间")]),t._v("\n")])])]),e("p",[e("strong",[t._v("E流程")]),t._v("： 钉钉拿着token请求微信资源服务器")]),t._v(" "),e("p",[e("strong",[t._v("F流程")]),t._v("： 微信资源服务器返回钉钉用户信息")]),t._v(" "),e("p",[t._v("refresh_token 作用：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("  +--------+                                           +---------------+\n  |        |--(A)------- Authorization Grant ---------\x3e|               |\n  |        |                                           |               |\n  |        |<-(B)----------- Access Token -------------|               |\n  |        |               & Refresh Token             |               |\n  |        |                                           |               |\n  |        |                            +----------+   |               |\n  |        |--(C)---- Access Token ----\x3e|          |   |               |\n  |        |                            |          |   |               |\n  |        |<-(D)- Protected Resource --| Resource |   | Authorization |\n  | Client |                            |  Server  |   |     Server    |\n  |        |--(E)---- Access Token ----\x3e|          |   |               |\n  |        |                            |          |   |               |\n  |        |<-(F)- Invalid Token Error -|          |   |               |\n  |        |                            +----------+   |               |\n  |        |                                           |               |\n  |        |--(G)----------- Refresh Token -----------\x3e|               |\n  |        |                                           |               |\n  |        |<-(H)----------- Access Token -------------|               |\n  +--------+           & Optional Refresh Token        +---------------+\n")])])]),e("h2",{attrs:{id:"授权方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#授权方式"}},[t._v("#")]),t._v(" 授权方式")]),t._v(" "),e("h3",{attrs:{id:"authorization-code-grant-授权码模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#authorization-code-grant-授权码模式"}},[t._v("#")]),t._v(" Authorization Code Grant (授权码模式)")]),t._v(" "),e("p",[t._v("本中上方例子就是授权码模式")]),t._v(" "),e("h3",{attrs:{id:"implicit-grant-简化隐式授权模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#implicit-grant-简化隐式授权模式"}},[t._v("#")]),t._v(" Implicit Grant（简化隐式授权模式）")]),t._v(" "),e("p",[t._v("省略 "),e("code",[t._v("授权码模式")]),t._v(" 中的获取 "),e("code",[t._v("code")]),t._v(" 步骤，  客户端直接向  授权服务器请求 token")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("客户端发起获取授权请求： 参数")]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("client_id")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("dingdingxxxxxxx           #表明请求来自钉钉")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("response_type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("token               #表明返回类型是token")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("scope")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("user                          #表明需要的授权范围为user")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("redirect_uri")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("https://dingtalk.com/register/callback  #表明用户确认后回调的URL")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("授权服务端， 根据 "),e("code",[t._v("redirect_uri")]),t._v("  返回数据")]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("access_token")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("er2rsersdf4534sds     #授权token")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("refresh_token")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("9834892sfsdfsf324    #刷新token ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("expire_in")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("864000\t\t\t\t\t\t#失效时间")]),t._v("\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"resource-owner-password-credentials-grant-用户密码授权模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#resource-owner-password-credentials-grant-用户密码授权模式"}},[t._v("#")]),t._v(" Resource Owner Password Credentials Grant(用户密码授权模式)")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("客户端向用户索要账号密码")])]),t._v(" "),e("li",[e("p",[t._v("客户端根据此凭证向  "),e("code",[t._v("授权服务器")]),t._v("  请求授权token")]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("  grant_type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("password")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("  username")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("tom")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("  password")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("A3ddj3w")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("授权服务器返回token")]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("access_token")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("er2rsersdf4534sds     #授权token")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("refresh_token")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("9834892sfsdfsf324    #刷新token ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("expire_in")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("864000\t\t\t\t\t\t#失效时间")]),t._v("\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"client-credentials-grant-客户端授权模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#client-credentials-grant-客户端授权模式"}},[t._v("#")]),t._v(" Client Credentials Grant (客户端授权模式)")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("     +---------+                                  +---------------+\n     |         |                                  |               |\n     |         |>--(A)- Client Authentication ---\x3e| Authorization |\n     | Client  |                                  |     Server    |\n     |         |<--(B)---- Access Token ---------<|               |\n     |         |                                  |               |\n     +---------+                                  +---------------+\n")])])]),e("p",[t._v("如图， 客户端直接与授权服务器交互")]),t._v(" "),e("blockquote",[e("p",[t._v("前提是client 是绝对信任的")])]),t._v(" "),e("ol",[e("li",[e("p",[t._v("客户端发起的请求参数如下")]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("grant_type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("client_credentials")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("授权服务器返回token")]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("access_token")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("er2rsersdf4534sds     #授权token")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("refresh_token")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("9834892sfsdfsf324    #刷新token ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("expire_in")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("864000\t\t\t\t   #失效时间")]),t._v("\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"refresh-token"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#refresh-token"}},[t._v("#")]),t._v(" Refresh Token")]),t._v(" "),e("p",[t._v("当 "),e("code",[t._v("client")]),t._v(" 的 "),e("code",[t._v("access_token")]),t._v(" 过期、失效时， 凭借 "),e("code",[t._v("refresh_token")]),t._v(" 向授权服务器请求新的 "),e("code",[t._v("access_token")]),t._v(",  请求数据如下")]),t._v(" "),e("ol",[e("li",[t._v("Client 请求参数如下")])]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v(" grant_type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("refresh_token")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v(" refresh_token")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("tGzv3JOkF0XG5Qx2TlKWIA")]),t._v("\n")])])]),e("ol",{attrs:{start:"2"}},[e("li",[t._v("授权服务器返回新的token信息")])])])}),[],!1,null,null,null);a.default=r.exports}}]);