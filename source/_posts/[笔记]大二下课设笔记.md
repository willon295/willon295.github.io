---
title: '[笔记]大二下课设总结'
category: 学习
tag: 笔记
id: 86
---

# 数据库触发器

1. 为什么要用触发器？
	主要是想要一个log的功能，当管理操作授权时，自动记录管理的操作的对象，时间，作了那些改动。如果用代码实现实在是太蠢了，费时费力。还会出bug。如果用数据库的触发器。当授权表发生改变时,触发器会生效，完成想要的功能。

2. 怎么写？

- 添加授权触发器(addtrigger)
	说明：添加授权时自动向日志表插入数据,

	```
	DROP TRIGGER IF EXISTS `addlog`;
	DELIMITER ;;
	CREATE TRIGGER `addlog` 
	AFTER INSERT ON `auth` FOR EACH ROW 
	insert into logauth 
	(operatetype,operatetime,username,userurl,authendtime)
	 values ('add',now(),new.username,new.userurl,new.authendtime)
	;;DELIMITER ;
	```
- 删除授权触发器(deletetrigger)
	说明：删除授权时自动向日志表插入数据。
	```
	DROP TRIGGER IF EXISTS `deletelog`;
	DELIMITER ;;
	CREATE TRIGGER `deletelog` BEFORE DELETE ON `auth` FOR EACH ROW
	insert into logauth 
	(operatetype,operatetime,username,userurl,authendtime) 
    values
	 ('delete',now(),old.username,old.userurl,old.authendtime)
	;;
	DELIMITER ;
	```
> new 表示新插入的的数据，old 表示原本的数据。before,after是触发的时间

# 监听器

1. 为什么要监听器

	想要这样一个功能：服务器的`项目启动时`，`自动定时`的扫描用户的到期时间，和当前时间进行对比，如果小于当前时间，将用户状态设置为无效。

2. 实现

	- 创建一个`Timer` 对象，调用`timer.schedule(TimerTask  timertask)`方法
	- 方法传入一个`timertask`对象
	- 重写`timertask` 的`run()`方法,这里写自动处理的代码；
	- 创建一个`Listenner` ,在方法`contextInitialized(ServletContextEvent sce)`中调用执行方法

3. 代码实现：

	执行任务的工具类

	```
	public class ScheduleTask {
    /**
     * 用于扫描用户授权 时间，如果时间小于当前时间，则将用户的状态改成无效
     * @throws Exception
     */
    public void scannerUserState() throws Exception {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
        AuthDAOImpl authDAO = new AuthDAOImpl();
        TimerTask timerTask = new TimerTask() {
            @Override
            public void run() {
                List authlist = null;
                try {
                    authlist = authDAO.getActiveAuth();
                    for (Object auths : authlist
                            ) {
                        Auth auth = (Auth) auths;
                            Date authdate = sdf.parse(auth.get_auth_end_time());
                            if (authdate.before(new Date())) {
                                authDAO.changeAuthState(auth);
                        }
                    }

                } catch (Exception e) {
                    e.printStackTrace();
                }

            }
        };
        Timer timer = new Timer();
		//参数：task 对象，开始时间，执行间隔
        timer.schedule(timerTask, new Date(), 60000);
    	}
	}
	```
	Listenner的关键代码
	```
    public void contextInitialized(ServletContextEvent sce) {
        ScheduleTask s= new ScheduleTask();
        try {
            s.scannerUserState();
        } catch (Exception e) {
            System.out.println("扫描启动失败");
        }

    }
	```

# 过滤器

用于登录安全验证、防止url传参进行数据注入。 

# 文档整理

## 系统总体架构图

![](http://blogimgs-1252094786.cossh.myqcloud.com/%E5%A4%A7%E4%BA%8C%E4%B8%8B%E8%AF%BE%E8%AE%BE/20170621215143_xtztjgt.jpg)

## 系统功能结构图

![](http://blogimgs-1252094786.cossh.myqcloud.com/%E5%A4%A7%E4%BA%8C%E4%B8%8B%E8%AF%BE%E8%AE%BE/20170621215040_xtgnjgt.jpg)

## 用例图

![](http://blogimgs-1252094786.cossh.myqcloud.com/%E5%A4%A7%E4%BA%8C%E4%B8%8B%E8%AF%BE%E8%AE%BE/20170621214826_usecase.jpg)

## 用例规约

![](http://blogimgs-1252094786.cossh.myqcloud.com/%E5%A4%A7%E4%BA%8C%E4%B8%8B%E8%AF%BE%E8%AE%BE/20170621214858_ylgy.jpg)
## 流程图

![](http://blogimgs-1252094786.cossh.myqcloud.com/%E5%A4%A7%E4%BA%8C%E4%B8%8B%E8%AF%BE%E8%AE%BE/20170621214922_lct.jpg)
## 数据库E-R图

![](http://blogimgs-1252094786.cossh.myqcloud.com/%E5%A4%A7%E4%BA%8C%E4%B8%8B%E8%AF%BE%E8%AE%BE/20170621214958_e-r.jpg)

## 时序图
![](http://blogimgs-1252094786.cossh.myqcloud.com/%E5%A4%A7%E4%BA%8C%E4%B8%8B%E8%AF%BE%E8%AE%BE/20170621215844_sxt.jpg)